name: Bootstrap App Repo

on:
  workflow_dispatch:
    inputs:
      app_code:
        description: "App code (e.g., app1)"
        required: true
      environment:
        description: "Environment (dev|stage|prod)"
        required: true
        default: "dev"
      subscription_id:
        description: "Target Azure subscription ID"
        required: true
      repo_name:
        description: "New repo name (will be created under org)"
        required: true
      github_org:
        description: "GitHub org"
        required: true
        default: "seera-eswara"
      template_repo:
        description: "Template repo to clone from"
        required: false
        default: "seera-eswara/app-infra-template"
      branch:
        description: "Branch to allow for OIDC subject"
        required: false
        default: "main"
      role_definition:
        description: "Azure role to assign"
        required: false
        default: "Contributor"

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write
  administration: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (minimal)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Azure Login (admin creds)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      - name: Create GitHub repo from template
        id: create_repo
        uses: actions/github-script@v7
        env:
          ORG: ${{ github.event.inputs.github_org }}
          REPO: ${{ github.event.inputs.repo_name }}
          TEMPLATE: ${{ github.event.inputs.template_repo }}
        with:
          github-token: ${{ secrets.BOOTSTRAP_PAT }}
          script: |
            const [templateOwner, templateRepo] = process.env.TEMPLATE.split('/');
            const org = process.env.ORG;
            const repo = process.env.REPO;
            // Create from template
            await github.repos.createUsingTemplate({
              template_owner: templateOwner,
              template_repo: templateRepo,
              owner: org,
              name: repo,
              include_all_branches: false,
              private: true
            });
            core.setOutput('repo_full', `${org}/${repo}`);

      - name: Create app registration + SP + federated credential
        id: sp
        run: |
          set -euo pipefail
          APP_CODE="${{ github.event.inputs.app_code }}"
          ENV="${{ github.event.inputs.environment }}"
          SUBSCRIPTION_ID="${{ github.event.inputs.subscription_id }}"
          ROLE="${{ github.event.inputs.role_definition }}"
          ORG="${{ github.event.inputs.github_org }}"
          REPO="${{ github.event.inputs.repo_name }}"
          BRANCH="${{ github.event.inputs.branch }}"
          DISPLAY_NAME="terraform-${APP_CODE}-${ENV}-ci"
          SUBJECT="repo:${ORG}/${REPO}:ref:refs/heads/${BRANCH}"

          echo "Creating app registration ${DISPLAY_NAME}"
          APP_ID=$(az ad app create --display-name "$DISPLAY_NAME" --query appId -o tsv)
          SP_ID=$(az ad sp create --id "$APP_ID" --query id -o tsv)
          TENANT_ID=$(az account show --query tenantId -o tsv)

          echo "Creating federated credential for ${SUBJECT}"
          az ad app federated-credential create \
            --id "$APP_ID" \
            --parameters "{\"name\":\"gh-${APP_CODE}-${ENV}\",\"issuer\":\"https://token.actions.githubusercontent.com\",\"subject\":\"${SUBJECT}\",\"audiences\":[\"api://AzureADTokenExchange\"]}"

          echo "Assigning role ${ROLE} at subscription ${SUBSCRIPTION_ID}"
          az role assignment create \
            --assignee "$SP_ID" \
            --role "$ROLE" \
            --scope "/subscriptions/${SUBSCRIPTION_ID}"

          echo "APP_ID=$APP_ID" >> $GITHUB_OUTPUT
          echo "SP_ID=$SP_ID" >> $GITHUB_OUTPUT
          echo "TENANT_ID=$TENANT_ID" >> $GITHUB_OUTPUT

      - name: Set GitHub secrets on new repo
        uses: actions/github-script@v7
        env:
          ORG: ${{ github.event.inputs.github_org }}
          REPO: ${{ github.event.inputs.repo_name }}
          APP_ID: ${{ steps.sp.outputs.APP_ID }}
          TENANT_ID: ${{ steps.sp.outputs.TENANT_ID }}
          SUBSCRIPTION_ID: ${{ github.event.inputs.subscription_id }}
        with:
          github-token: ${{ secrets.BOOTSTRAP_PAT }}
          script: |
            const secretsApi = github.actions;
            const owner = process.env.ORG;
            const repo = process.env.REPO;

            async function putSecret(name, value) {
              await secretsApi.createOrUpdateRepoSecret({
                owner,
                repo,
                secret_name: name,
                encrypted_value: value,
              });
            }

            await putSecret('ARM_CLIENT_ID', process.env.APP_ID);
            await putSecret('ARM_TENANT_ID', process.env.TENANT_ID);
            await putSecret('ARM_SUBSCRIPTION_ID', process.env.SUBSCRIPTION_ID);
            await putSecret('ARM_USE_OIDC', 'true');

      - name: Summary
        run: |
          echo "Repo: ${{ steps.create_repo.outputs.repo_full }}"
          echo "App ID: ${{ steps.sp.outputs.APP_ID }}"
          echo "SP Object ID: ${{ steps.sp.outputs.SP_ID }}"
          echo "Tenant: ${{ steps.sp.outputs.TENANT_ID }}"
          echo "Secrets set: ARM_CLIENT_ID, ARM_TENANT_ID, ARM_SUBSCRIPTION_ID, ARM_USE_OIDC"
